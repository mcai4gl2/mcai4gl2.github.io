name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Set a branch to deploy
  pull_request:
    branches:
      - main

jobs:
  # Job 1: Build and test DevContainer
  build-and-test-devcontainer:
    runs-on: ubuntu-latest
    outputs:
      container-image: ${{ steps.build.outputs.imageid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build DevContainer image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./.devcontainer/Dockerfile
          push: false
          load: true
          tags: hugo-devcontainer:test
          outputs: type=image,name=hugo-devcontainer,push=false

      - name: Run Python unit tests in container
        run: |
          # Run tests without coverage to avoid permission issues
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            --entrypoint python3 \
            hugo-devcontainer:test \
            -m pytest tests/ -v

      - name: Generate coverage report
        run: |
          # Generate coverage report separately
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            --entrypoint python3 \
            hugo-devcontainer:test \
            -m pytest tests/ --cov=image_optimizer --cov-report=xml --cov-report=term-missing 2>&1 | grep -v "INTERNALERROR" || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Test image optimizer CLI in container
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            --entrypoint image-optimizer \
            hugo-devcontainer:test \
            --help

      - name: Test image optimizer analysis in container
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            --entrypoint image-optimizer \
            hugo-devcontainer:test \
            analyze static/meat

      - name: Run Hugo build in container
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            --entrypoint bash \
            hugo-devcontainer:test \
            -c "hugo --source=/src --destination=/src/public --gc --minify"

      - name: Verify public directory exists
        run: |
          ls -la public || exit 1

  # Job 2: Deploy to GitHub Pages (only runs on main branch and after tests pass)
  deploy:
    runs-on: ubuntu-20.04
    needs: build-and-test-devcontainer
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          # extended: true

      - name: Build
        run: hugo --minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public